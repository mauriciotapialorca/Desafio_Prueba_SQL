CREATE TABLE IF NOT EXISTS public."SOCIOS"
(
    "RUT" character varying(13),
    nombre character varying(30),
    apellido character varying(30),
    "DIRECCION" character varying(30),
    "TELEFONO" integer,
    "ISBN_LIBRO" serial,
    PRIMARY KEY ("RUT")
);

INSERT INTO SOCIOS (RUT, nombre, apellido, DIRECCION, TELEFONO, ISBN_LIBRO) VALUES ('1111111-1','JUAN','SOTO', 'AVENIDA 1 SANTIAGO', 911111111,111-111
1111-111);
INSERT INTO SOCIOS (RUT, nombre, apellido, DIRECCION, TELEFONO, ISBN_LIBRO) VALUES ('2222222-2','ANA','PÉREZ', 'PASAJE 2 SANTIAGO', 922222222, 111-1111111-111
); 
INSERT INTO SOCIOS (RUT, nombre, apellido, DIRECCION, TELEFONO, ISBN_LIBRO) VALUES ('3333333-3', 'SANDRA','AGUILAR','AVENIDA 2 SANTIAGO', 933333333,222-222
2222-222);
INSERT INTO SOCIOS (RUT, nombre, apellido, DIRECCION, TELEFONO, ISBN_LIBRO) VALUES ('4444444-4','ESTEBAN','JEREZ','AVENIDA 3 SANTIAGO',944444444,333-333
3333-333
); 
INSERT INTO SOCIOS (RUT, nombre, apellido, DIRECCION, TELEFONO, ISBN_LIBRO) VALUES ('5555555-5','SILVANA','MUÑOZ','PASAJE 3 SANTIAGO',955555555,444-444
4444-444);


CREATE TABLE IF NOT EXISTS public."LIBROS"
(
    "ISBN" serial,
    "TITULO" character varying(30),
    "PAG" integer,
    "COD_AUTOR" character varying(30),
    "COD_TIPO_AUTOR" integer,
    "NACIM-MUERTE" date,
    "RUT_SOCIO" character varying(13),
    PRIMARY KEY ("ISBN")
);

ALTER TABLE IF EXISTS public."LIBROS"
    ADD FOREIGN KEY ("RUT_SOCIO")
    REFERENCES public."SOCIOS" ("RUT") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;


ALTER TABLE IF EXISTS public."LIBROS"
    ADD FOREIGN KEY ("COD_TIPO_AUTOR")
    REFERENCES public."TIPO_AUTOR" ("CODIGO_TIPO") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;


ALTER TABLE IF EXISTS public."LIBROS"
    ADD FOREIGN KEY ("COD_AUTOR")
    REFERENCES public."AUTOR" ("COD_AUTOR") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;

INSERT INTO LIBROS (ISBN,TITULO,PAG, COD_AUTOR,NACIM_MUERTE,COD_TIPO_AUTOR,RUT_SOCIO) VALUES (111-1111111-111,'CUENTOS DE TERROR', 344, 3,2012-01-01,1,111-111
1111-111);
INSERT INTO LIBROS (ISBN,TITULO,PAG, COD_AUTOR,NACIM_MUERTE,COD_TIPO_AUTOR,RUT_SOCIO) VALUES (111-1111111-111,'CUENTOS DE TERROR', 344, 4,2013-02-02,2,111-111
1111-111);
INSERT INTO LIBROS (ISBN,TITULO,PAG, COD_AUTOR,NACIM_MUERTE,COD_TIPO_AUTOR,RUT_SOCIO) VALUES (222-2222222-222,'POESÍAS CONTEMPORANEAS', 167,1,2014-03-03,1,222-222
2222-222);
INSERT INTO LIBROS (ISBN,TITULO,PAG, COD_AUTOR,NACIM_MUERTE,COD_TIPO_AUTOR,RUT_SOCIO) VALUES (333-3333333-333,'HISTORIA DE ASIA', 511, 2,2015-04_04, 1,333-333
3333-333);
INSERT INTO LIBROS (ISBN,TITULO,PAG, COD_AUTOR,NACIM_MUERTE,COD_TIPO_AUTOR,RUT_SOCIO) VALUES (444-4444444-444,'MANUAL DE MECÁNICA', 298, 5,2016-05-05, 1,444-444
4444-444);

CREATE TABLE IF NOT EXISTS public."PRESTAMO"
(
    "ISBN" serial,
    PRIMARY KEY ("ISBN")
);

ALTER TABLE IF EXISTS public."PRESTAMO"
    ADD FOREIGN KEY ("ISBN")
    REFERENCES public."SOCIOS" ("ISBN_LIBRO") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;
END;

INSERT INTO PRESTAMOS(ISBN) VALUES(111-1111111-111);
INSERT INTO PRESTAMOS(ISBN) VALUES(111-1111111-111);
INSERT INTO PRESTAMOS(ISBN) VALUES(222-2222222-222);
INSERT INTO PRESTAMOS(ISBN) VALUES(333-3333333-333);
INSERT INTO PRESTAMOS(ISBN) VALUES(444-4444444-444);


CREATE TABLE IF NOT EXISTS public."HISTORIAL_PRESTAMOS_LIBROS"
(
    "ISBN" serial,
    "FECHA_INICIO" date,
    "FECHA_TERMINO" date,
    PRIMARY KEY ("ISBN")
);

ALTER TABLE IF EXISTS public."HISTORIAL_PRESTAMOS_LIBROS"
    ADD FOREIGN KEY ("ISBN")
    REFERENCES public."PRESTAMO" ("ISBN") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;


ALTER TABLE IF EXISTS public."HISTORIAL_PRESTAMOS_LIBROS"
    ADD FOREIGN KEY ("ISBN")
    REFERENCES public."PRESTAMO" ("ISBN") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;


INSERT INTO HISTORIAL_DE_PRESTAMOS(ISBN, FECHA_INICIO,FECHA_TERMINO) VALUES (111-1111111-111, 2020-01-01, 2020-01-27);

INSERT INTO HISTORIAL_DE_PRESTAMOS(ISBN, FECHA_INICIO,FECHA_TERMINO) VALUES (111-1111111-111, 2020-01-01, 2020-01-27);

INSERT INTO HISTORIAL_DE_PRESTAMOS(ISBN, FECHA_INICIO, FECHA_TERMINO) VALUES(222-2222222-222, 3333333-3, 2020-01-20);

INSERT INTO HISTORIAL_DE_PRESTAMOS(ISBN, FECHA_INICIO, FECHA_TERMINO) VALUES(333-3333333-333, 3333333-3, 2020-01-20);

INSERT INTO HISTORIAL_DE_PRESTAMOS(ISBN, FECHA_INICIO, FECHA_TERMINO) VALUES(333-3333333-333, 3333333-3, 2020-01-20);


CREATE TABLE IF NOT EXISTS public."AUTOR"
(
    "COD_AUTOR" integer,
    "NOMBRE_AUTOR" character varying,
    "APELLIDO_AUTOR" character varying,
    "FECHA" date
);

ALTER TABLE IF EXISTS public."AUTOR"
    ADD FOREIGN KEY ("COD_AUTOR")
    REFERENCES public."LIBROS" ("COD_AUTOR") MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION
    NOT VALID;

INSERT INTO AUTOR(COD_AUTOR, NOMBRE_AUTOR, APELLIDO_AUTOR, FECHA) VALUES (3,'JOSE', 'SALGADO','2022-01-01');
INSERT INTO AUTOR(COD_AUTOR, NOMBRE_AUTOR, APELLIDO_AUTOR, FECHA) VALUES (4,'ANA', 'SALGADO','2022-01-01');
INSERT INTO AUTOR(COD_AUTOR, NOMBRE_AUTOR, APELLIDO_AUTOR, FECHA) VALUES (1,'ANDRÉS','ULLOA','2022_01-02');
INSERT INTO AUTOR(COD_AUTOR, NOMBRE_AUTOR, APELLIDO_AUTOR, FECHA) VALUES (2,'SERGIO','MARDONES','2022-01-02');
INSERT INTO AUTOR(COD_AUTOR, NOMBRE_AUTOR, APELLIDO_AUTOR, FECHA) VALUES (5,'MARTIN','PORTA','2021-01-01');



CREATE TABLE IF NOT EXISTS public."TIPO_AUTOR"
(
    "CODIGO_TIPO" serial,
    "DESCRIPCION" character varying
);

INSERT INTO TIPO_AUTOR(CODIGO_TIPO, DESCRIPCION) VALUES (1, 'PRINCIPAL');

INSERT INTO TIPO_AUTOR(CODIGO_TIPO, DESCRIPCION) VALUES (1, 'PRINCIPAL');

INSERT INTO TIPO_AUTOR(CODIGO_TIPO, DESCRIPCION) VALUES (1, 'PRINCIPAL');

INSERT INTO TIPO_AUTOR(CODIGO_TIPO, DESCRIPCION) VALUES (2, 'COAUTOR');

INSERT INTO TIPO_AUTOR(CODIGO_TIPO, DESCRIPCION) VALUES (3, 'PRINCIPAL');

INSERT INTO TIPO_AUTOR(CODIGO_TIPO, DESCRIPCION) VALUES (4, 'PRINCIPAL');

INSERT INTO TIPO_AUTOR(CODIGO_TIPO, DESCRIPCION) VALUES (5, 'PRINCIPAL');


select libros.isbn, autor.nombre_autor, autor.apellido_autor 
from libros, autor,tipo_autor
where libros.pag >=300
and libros.cod_autor = autor.cod_autor
and libros.cod_tipo_autor = tipo_autor.codigo_tipo; 


select autores.nombre, autores.apellido from autores
where autores.fecha >= 1970;


select MAX(HISTORIAL_PRESTAMOS_LIBROS.ISBN), HISTORIAL_PRESTAMOS_LIBROS.ISBN 
from HISTORIAL_PRESTAMOS_LIBROS
GROUP BY HISTORIAL_PRESTAMOS_LIBROS.FECHA_TERMINO
ORDER BY HISTORIAL_PRESTAMOS_LIBROS.ISBN;


select sum(100) from historal_de_prestamos
where historial_de_prestamos.fecha_termino >= (select historial_de_prestamos.isbn from historial_de_prestamos
where historial_de_prestamos.fecha_termino > date();)

